{literal}
    <style>
        hr.plugmein {clear: none;}
        .disabled {color: gray; text-decoration: line-through;}
        .plugmein tr:hover {box-shadow: inset 0 0 0 1px #7D6A6A;}
        .s-plugmein-panel {display: block; position: fixed; bottom: 0; left: 0; right: 0; background: #fff; box-shadow: 0 -6px 10px -10px #AAAAAA;
            z-index: 1052;
            padding-left: 40%;
        }

        body.night .s-plugmein-panel {
            background: var(--main-bg-color);
            box-shadow: none;
        }
    </style>
    <div class="float-right">
        <a href="https://www.patreon.com/bePatron?u=25425773" target="_blank">
            <i class="icon16 dollar"></i>[`Donate`]</a>
    </div>
{/literal}
<div id="s-plugmein-form" class="plugmein">
    <h2>[`Plugin Manager`]</h2>
    <div class="block fields form">
        <span id="plugmein-error"></span>
        <ul class="tabs">
            <li>
                <a href="#" data-tab-id='plugins'>[s`Plugins`]</a>
            </li>
            <li>
                <a href="#" data-tab-id='hooks'>[`Hooks`]</a>
            </li>
            <li>
                <a href="#" data-tab-id='diag'>[`Diagnose`]</a>
            </li>
            <li>
                <a href="#" data-tab-id='settings'>[`Settings`]</a>
            </li>
        </ul>
        <div class="tab-content">
            <!--plugins.tab-->
            <div class="block" data-tabcontent-id="plugins">
                <button class="button" id="plugmein-checkAll" title="[`Select all`]">☑</button>
                |
                <button class="button" id="plugmein-uncheckAll" title="[`Select none`]">☐</button>
                <a href="?plugin=plugmein&id=savelist" class="float-right" id="plugmein-savelist" title="[`Save list`]">
                    <i class="icon16 download"></i>[`Save list`]
                </a>
                <hr class="plugmein">
                <form id="plugmein-form" method="POST" action="?plugin=plugmein">
                    {if empty($plugin_list)}
                        <h3> [`No plugins available`]</h3>
                    {else}
                        {$wa->csrf()}
                        <table class="zebra plugmein">
                            {foreach $plugin_list as $plugin}
                                <tr>
                                    <td ><label {if !$plugin.active} class="disabled"{/if} for="{$plugin.id}">&nbsp;
                                        <input type="checkbox" name="{$plugin.id}" id="{$plugin.id}" value="1"
                                               {if $plugin.active}checked="checked"{/if}>
                                            {$plugin.name|default: $plugin.id|escape}
                                            &nbsp;<span> {$plugin.description|default: ''|escape}</span></label></td>
                                    {if $installer}
                                        <td class="nowrap">
                                            <span class="float-right"><a
                                                        title="{$plugin.name|default: $plugin.id}"
                                                        href="{$wa_backend_url}installer/store/plugin/shop/{$plugin.id}/"
                                                        target="_blank">{_wp("Go to Installer")}</a>
                                            </span></td>
                                    {/if}
                                </tr>
                            {/foreach}
                        </table>
                    {/if}
                    <hr class="plugmein">
                    <div class="block bordered-top s-plugmein-panel">
                        <input type="submit" class="green button" value="[`Save`]">
                    </div>
                </form>
            </div>
            <!--hooks.tab-->
            <div class="block" data-tabcontent-id="hooks">
                <h2>[`Hooks`]</h2>
                <table class="zebra">
                    {foreach $handlers as $hook => $plugin}
                        <tr>
                            <td>{$hook}</td>
                            <td>{if is_array($plugin)}
                                    {foreach $plugin as $handler}
                                        <span {if !$plugin_list[$handler]['active']|default:false}class="disabled"{/if}>
                                            {$plugin_list[$handler].name|default:$plugin_list[$handler].id}
                                        </span>
                                        <br>
                                    {/foreach}
                                {else}
                                <span {if !$plugin_list[$plugin]['active']|default:false}class="disabled"{/if}>
                                    {$plugin_list[$plugin].name|default:$plugin_list[$plugin].id}
                                    -
                                </span>
                                {/if}
                            </td>
                        </tr>
                    {/foreach}
                </table>
            </div>
            <!--diag.tab-->
            <div class="block" data-tabcontent-id="diag">
                <h3>[`Test checksums`]</h3>
                <script async defer src="{$wa_app_static_url}plugins/plugmein/js/kmlongaction.js" type="text/javascript"></script>
                <input type="button" class="button green" id="diag-run-check" value="[`Start`]"/>
                <img id="diag-loading-check" style="margin-top:8px; display: none"
                     src="{$wa_static_url}wa-content/img/loading32.gif"><br><br>
                {*
                <h3>[`Test BOM`]</h3>
                <input type="button" class="button green" id="bom-run-check" value="[`Start`]"/>
                <img id="bom-loading-check" style="margin-top:8px; display: none"
                     src="{$wa_static_url}wa-content/img/loading32.gif"><br><br>
                *}
                {if isset($classes)}
                    <h3>[`Hooks history total time`]</h3>
                    <div>
                        <table class="zebra">
                            <tr>
                                <td>Class</td>
                                <td>Time (s)</td>
                            </tr>
                            {foreach $classes as $c => $time}
                                <tr>
                                    {if shopPlugmeinPluginSettingsAction::classToLink($c)}
                                        <td>
                                            <a href="{$wa_backend_url}installer/#/{shopPlugmeinPluginSettingsAction::classToLink($c)}">{$c}</a>
                                        </td>
                                    {else}
                                        <td>{$c}</td>
                                    {/if}

                                    <td>{$time}</td>
                                </tr>
                            {/foreach}
                        </table>
                    </div>
                    <br>
                    <br>
                {/if}

                {if isset($methods)}
                    <div>
                        <table class="zebra">
                            <tr>
                                <td>Method</td>
                                <td>Time (s)</td>
                            </tr>
                            {foreach $methods as $m => $time}
                                <tr>
                                    <td>{$m}</td>
                                    <td>{$time}</td>
                                </tr>
                            {/foreach}
                        </table>
                    </div>
                {/if}

            </div>

            <!--settings.tab-->
            <div class="block" data-tabcontent-id="settings">
                {include file="../../../../../templates/actions/plugins/PluginsSettings.html"}
            </div>

        </div>
    </div>
</div>
{literal}
<script>
    /*global $*/
    let plugmeinForm = $('#plugmein-form');

    $('#plugmein-checkAll').click(function () {
        $('input[type="checkbox"]', plugmeinForm).prop('checked', true);
    });

    $('#plugmein-uncheckAll').click(function () {
        $('input[type="checkbox"]', plugmeinForm).prop('checked', false);
    });

    $('#s-plugmein-form').on('click', 'a[data-tab-id]', function (e) {
        e.preventDefault();
        $('a[data-tab-id]').parent().removeClass('selected');
        $(this).parent().addClass('selected');
        $('div[data-tabcontent-id]', '.tab-content').hide();
        $('div[data-tabcontent-id=' + $(this).data('tab-id') + ']', '.tab-content').show();
    });
    plugmeinForm.on('submit', function (e) {
        let fields = plugmeinForm.serializeArray();
        e.preventDefault();
        fields.push({ "name": 'id', "value": 'run'});
        /* Because serializeArray() ignores unset checkboxes and radio buttons: */
        console.log(fields);
        fields = fields.concat(
            $('input[type=checkbox]:not(:checked)', plugmeinForm).map(
                function () {
                    return { "name": this.name, "value": 0};
                }).get()
        );
        console.log(fields);
        $.post(plugmeinForm.attr('action'), fields).done(function () {
            window.location.reload();
        });
    });

    $("#diag-run-check").click(function (e) {
        $.wa.kmLongAction().start({
            process_url: '?plugin=plugmein&action=check',
            debug: true,
            start: {
                onStart: function () {
                    $('.errormsg', '[data-tabcontent-id="diag"]').empty();
                    $("#diag-run-check").hide();
                    $("#diag-loading-check").show();
                }
            },
            step: {
                onReady: function (response) {
                    $("#diag-run-check").after(response.report).show();
                    $("#diag-loading-check").hide();
                }
            }
        });
    });

    $("#bom-run-check").click(function (e) {
        $.wa.kmLongAction().start({
            process_url: '?plugin=plugmein&action=checkbom',
            debug: true,
            start: {
                onStart: function () {
                    $('.errormsg', '[data-tabcontent-id="diag"]').empty();
                    $("#bom-run-check").hide();
                    $("#bom-loading-check").show();
                }
            },
            step: {
                onReady: function (response) {
                    $("#bom-run-check").after(response.report).show();
                    $("#bom-loading-check").hide();
                }
            }
        });
    });

    $('a[data-tab-id]:first', '#s-plugmein-form').trigger('click');
</script>
{/literal}